@startuml SendOtpFunction

participant PageLogin
participant UserController
participant UserServiceImpl as UserService
participant UserRepository
participant OtpCache
participant EmailServiceImpl as EmailService

== Lược đồ tuần tự chức năng gửi OTP qua email ==

PageLogin -> UserController: POST /api/users/forgot-password/send-otp {email}
activate UserController

UserController -> UserService: sendOtpForPasswordReset(email)
activate UserService

alt Email rỗng (email.trim().isEmpty())
    UserService -> UserService: throw RuntimeException("Email không được để trống.")
    UserService --> UserController: throw RuntimeException
    UserController --> PageLogin: Response (400 Bad Request, "Email không được để trống.")

end

UserService -> UserRepository: findByEmail(email)
activate UserRepository
UserRepository --> UserService: Optional<User>
deactivate UserRepository

alt Email không tồn tại (user.isEmpty())
    UserService -> UserService: throw RuntimeException("Email không tồn tại.")
    UserService --> UserController: throw RuntimeException
    UserController --> PageLogin: Response (404 Not Found, "Email không tồn tại.")
end

UserService -> UserService: generateOtp()
UserService -> OtpCache: lưu OTP và timestamp

UserService -> EmailService: sendOtpByEmail(email, otp)
activate EmailService
EmailService --> UserService: Email sent
deactivate EmailService

UserService --> UserController: Success
deactivate UserService

UserController --> PageLogin: Response (200 OK)
deactivate UserController

@enduml
